<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotiFyah - ì‹¤ì‹œê°„ ìƒí˜¸ ì•Œë¦¼ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        .auth-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, button, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected {
            background: #c8e6c9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .status.disconnected {
            background: #ffcdd2;
            color: #c62828;
            border: 1px solid #f44336;
        }
        .notifications {
            margin-top: 20px;
        }
        .notification-item {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        .notification-item.read {
            background: #f5f5f5;
            border-color: #ddd;
            opacity: 0.7;
        }
        .notification-type {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .notification-content {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }
        .notification-time {
            font-size: 12px;
            color: #666;
        }
        .notification-actions {
            margin-top: 10px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
            width: auto;
        }
        .btn-success {
            background: #4caf50;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-warning {
            background: #ff9800;
        }
        .connection-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .connection-info h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        .send-notification {
            background: #fff8e1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffc107;
        }
        .send-notification h3 {
            margin-top: 0;
            color: #f57c00;
        }
        .send-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        .send-form .form-group:last-child {
            grid-column: 1 / -1;
        }
        .log-section {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.info { color: #2196F3; }
        .log-entry.success { color: #4caf50; }
        .log-entry.warning { color: #ff9800; }
        .log-entry.error { color: #f44336; }
        .stats-section {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #9c27b0;
        }
        .stats-section h3 {
            margin-top: 0;
            color: #7b1fa2;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e1bee7;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #9c27b0;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” NotiFyah - ì‹¤ì‹œê°„ ìƒí˜¸ ì•Œë¦¼ ì‹œìŠ¤í…œ</h1>
        
        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div class="auth-section">
            <h3>ğŸ” ì¸ì¦</h3>
            <div class="form-group">
                <label for="username">ì‚¬ìš©ìëª… ë˜ëŠ” ì´ë©”ì¼:</label>
                <input type="text" id="username" placeholder="john_doe" value="john_doe">
            </div>
            <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="password" placeholder="password123" value="password123">
            </div>
            <button onclick="login()">ë¡œê·¸ì¸</button>
            <button onclick="signup()" style="background: #4caf50;">íšŒì›ê°€ì…</button>
        </div>

        <!-- ì—°ê²° ìƒíƒœ -->
        <div class="connection-info">
            <h3>ğŸ“¡ ì—°ê²° ìƒíƒœ</h3>
            <div id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
            <div id="userInfo">ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <!-- WebSocket ì—°ê²° -->
        <div class="form-group">
            <button id="connectBtn" onclick="connectWebSocket()" disabled>WebSocket ì—°ê²°</button>
            <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>ì—°ê²° í•´ì œ</button>
        </div>

        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="stats-section">
            <h3>ğŸ“Š ì•Œë¦¼ í†µê³„</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalNotifications">0</div>
                    <div class="stat-label">ì „ì²´ ì•Œë¦¼</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="unreadNotifications">0</div>
                    <div class="stat-label">ì½ì§€ ì•Šì€ ì•Œë¦¼</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sentNotifications">0</div>
                    <div class="stat-label">ë³´ë‚¸ ì•Œë¦¼</div>
                </div>
            </div>
        </div>

        <!-- ì•Œë¦¼ ì „ì†¡ ì„¹ì…˜ -->
        <div class="send-notification">
            <h3>ğŸ“¤ ì•Œë¦¼ ì „ì†¡í•˜ê¸°</h3>
            <div class="send-form">
                <div class="form-group">
                    <label for="targetUserId">ë°›ëŠ” ì‚¬ìš©ì ID:</label>
                    <input type="number" id="targetUserId" placeholder="2" value="2">
                </div>
                <div class="form-group">
                    <label for="eventType">ì•Œë¦¼ íƒ€ì…:</label>
                    <select id="eventType">
                        <option value="NEW_COMMENT">ìƒˆ ëŒ“ê¸€</option>
                        <option value="NEW_FOLLOW">ìƒˆ íŒ”ë¡œì›Œ</option>
                        <option value="POST_LIKED">ì¢‹ì•„ìš”</option>
                        <option value="SYSTEM">ì‹œìŠ¤í…œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="entityId">ì—”í‹°í‹° ID:</label>
                    <input type="number" id="entityId" placeholder="123" value="123">
                </div>
                <div class="form-group">
                    <label for="redirectUrl">ë¦¬ë‹¤ì´ë ‰íŠ¸ URL:</label>
                    <input type="text" id="redirectUrl" placeholder="/posts/123" value="/posts/123">
                </div>
                <div class="form-group">
                    <label for="notificationContent">ì•Œë¦¼ ë‚´ìš©:</label>
                    <input type="text" id="notificationContent" placeholder="ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ì•Œë¦¼ì…ë‹ˆë‹¤." value="ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ì•Œë¦¼ì…ë‹ˆë‹¤.">
                </div>
            </div>
            <button onclick="sendNotification()" class="btn-warning">ğŸ“¤ ì•Œë¦¼ ì „ì†¡</button>
        </div>

        <!-- ë©”ì¸ ê·¸ë¦¬ë“œ -->
        <div class="main-grid">
            <!-- ì™¼ìª½: ì•Œë¦¼ ëª©ë¡ -->
            <div class="notifications">
                <h3>ğŸ“‹ ë‚´ ì•Œë¦¼ ëª©ë¡</h3>
                <button onclick="loadNotifications()" class="btn-small">ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="markAllAsRead()" class="btn-small btn-success">ëª¨ë‘ ì½ìŒ ì²˜ë¦¬</button>
                <div id="notificationsList"></div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë¹ ë¥¸ ì „ì†¡ -->
            <div class="notifications">
                <h3>âš¡ ë¹ ë¥¸ ì•Œë¦¼ ì „ì†¡</h3>
                <div class="form-group">
                    <label for="quickTargetUserId">ë°›ëŠ” ì‚¬ìš©ì ID:</label>
                    <input type="number" id="quickTargetUserId" placeholder="2" value="2">
                </div>
                <button onclick="sendQuickNotification('NEW_COMMENT', 'ìƒˆë¡œìš´ ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤!')" class="btn-small btn-success">ğŸ’¬ ëŒ“ê¸€ ì•Œë¦¼</button>
                <button onclick="sendQuickNotification('NEW_FOLLOW', 'ìƒˆë¡œìš´ íŒ”ë¡œì›Œê°€ ìƒê²¼ìŠµë‹ˆë‹¤!')" class="btn-small btn-warning">ğŸ‘¥ íŒ”ë¡œì›Œ ì•Œë¦¼</button>
                <button onclick="sendQuickNotification('POST_LIKED', 'í¬ìŠ¤íŠ¸ì— ì¢‹ì•„ìš”ê°€ ëˆŒë ¸ìŠµë‹ˆë‹¤!')" class="btn-small btn-danger">â¤ï¸ ì¢‹ì•„ìš” ì•Œë¦¼</button>
                <button onclick="sendQuickNotification('SYSTEM', 'ì‹œìŠ¤í…œ ì•Œë¦¼ì…ë‹ˆë‹¤!')" class="btn-small">ğŸ”” ì‹œìŠ¤í…œ ì•Œë¦¼</button>
            </div>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="log-section">
            <h4>ğŸ“ ì‹œìŠ¤í…œ ë¡œê·¸</h4>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let authToken = null;
        let currentUser = null;
        let sentCount = 0;

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ë¡œê·¸ì¸ í•¨ìˆ˜
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usernameOrEmail: username,
                        password: password
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data;
                    
                    document.getElementById('userInfo').innerHTML = `
                        <strong>ì‚¬ìš©ì:</strong> ${data.username} (${data.fullName})<br>
                        <strong>ì´ë©”ì¼:</strong> ${data.email}<br>
                        <strong>ê¶Œí•œ:</strong> ${data.roles.join(', ')}<br>
                        <strong>ì‚¬ìš©ì ID:</strong> ${data.userId}
                    `;
                    
                    document.getElementById('connectBtn').disabled = false;
                    log('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                    loadNotifications();
                } else {
                    const error = await response.text();
                    log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error}`, 'error');
                    alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                log(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íšŒì›ê°€ì… í•¨ìˆ˜
        async function signup() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: `${username}@example.com`,
                        password: password,
                        fullName: username
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log('íšŒì›ê°€ì… ì„±ê³µ! ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.', 'success');
                    authToken = data.token;
                    currentUser = data;
                    
                    document.getElementById('userInfo').innerHTML = `
                        <strong>ì‚¬ìš©ì:</strong> ${data.username} (${data.fullName})<br>
                        <strong>ì´ë©”ì¼:</strong> ${data.email}<br>
                        <strong>ê¶Œí•œ:</strong> ${data.roles.join(', ')}<br>
                        <strong>ì‚¬ìš©ì ID:</strong> ${data.userId}
                    `;
                    
                    document.getElementById('connectBtn').disabled = false;
                    loadNotifications();
                } else {
                    const error = await response.text();
                    log(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${error}`, 'error');
                    alert('íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                log(`íšŒì›ê°€ì… ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            if (!authToken) {
                log('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                ws = new WebSocket(`ws://localhost:8080/ws/notifications?token=${authToken}`);

                ws.onopen = function(event) {
                    log('WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                    document.getElementById('connectionStatus').className = 'status connected';
                    document.getElementById('connectionStatus').textContent = 'ì—°ê²°ë¨';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                };

                ws.onmessage = function(event) {
                    try {
                        const notification = JSON.parse(event.data);
                        log(`ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ì‹ : ${notification.content}`, 'success');
                        addNotificationToList(notification);
                        showNotificationToast(notification);
                        updateStats();
                    } catch (error) {
                        log(`ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                };

                ws.onclose = function(event) {
                    log('WebSocket ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                    document.getElementById('connectionStatus').className = 'status disconnected';
                    document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì•ˆë¨';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                };

                ws.onerror = function(error) {
                    log(`WebSocket ì˜¤ë¥˜: ${error}`, 'error');
                };

            } catch (error) {
                log(`WebSocket ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // WebSocket ì—°ê²° í•´ì œ
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ì•Œë¦¼ ì „ì†¡ í•¨ìˆ˜
        async function sendNotification() {
            if (!authToken) {
                log('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            const targetUserId = document.getElementById('targetUserId').value;
            const eventType = document.getElementById('eventType').value;
            const entityId = document.getElementById('entityId').value;
            const redirectUrl = document.getElementById('redirectUrl').value;
            const content = document.getElementById('notificationContent').value;

            if (!targetUserId || !content) {
                alert('ë°›ëŠ” ì‚¬ìš©ì IDì™€ ì•Œë¦¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const notificationData = {
                    eventType: eventType,
                    senderId: currentUser.id,
                    targetUserId: parseInt(targetUserId),
                    entityId: parseInt(entityId),
                    content: content,
                    redirectUrl: redirectUrl
                };

                // ì‹¤ì œ API í˜¸ì¶œë¡œ ì•Œë¦¼ ì „ì†¡
                const response = await fetch('http://localhost:8080/api/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(notificationData)
                });

                if (response.ok) {
                    log(`ì•Œë¦¼ ì „ì†¡ ì„±ê³µ: ${content} â†’ ì‚¬ìš©ì ${targetUserId}`, 'success');
                    
                    // ë³´ë‚¸ ì•Œë¦¼ ì¹´ìš´íŠ¸ ì¦ê°€
                    sentCount++;
                    updateStats();
                    
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('notificationContent').value = '';
                    
                } else {
                    const error = await response.text();
                    log(`ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${error}`, 'error');
                }
                
            } catch (error) {
                log(`ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë¹ ë¥¸ ì•Œë¦¼ ì „ì†¡ í•¨ìˆ˜
        async function sendQuickNotification(eventType, content) {
            const targetUserId = document.getElementById('quickTargetUserId').value;
            if (!targetUserId) {
                alert('ë°›ëŠ” ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ë¹ ë¥¸ ì „ì†¡ API í˜¸ì¶œ
                const response = await fetch(`http://localhost:8080/api/notifications/send/quick?eventType=${eventType}&targetUserId=${targetUserId}&content=${encodeURIComponent(content)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    log(`ë¹ ë¥¸ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ: ${content} â†’ ì‚¬ìš©ì ${targetUserId}`, 'success');
                    
                    // ë³´ë‚¸ ì•Œë¦¼ ì¹´ìš´íŠ¸ ì¦ê°€
                    sentCount++;
                    updateStats();
                    
                } else {
                    const error = await response.text();
                    log(`ë¹ ë¥¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${error}`, 'error');
                }
                
            } catch (error) {
                log(`ë¹ ë¥¸ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì•Œë¦¼ ëª©ë¡ ë¡œë“œ
        async function loadNotifications() {
            if (!authToken) {
                log('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayNotifications(data.content);
                    updateStats();
                    log(`ì•Œë¦¼ ${data.content.length}ê°œ ë¡œë“œë¨`, 'info');
                } else {
                    log('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                log(`ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = '<p>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            notifications.forEach(notification => {
                addNotificationToList(notification);
            });
        }

        // ì•Œë¦¼ì„ ëª©ë¡ì— ì¶”ê°€
        function addNotificationToList(notification) {
            const container = document.getElementById('notificationsList');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification-item ${notification.read ? 'read' : ''}`;
            notificationDiv.id = `notification-${notification.id}`;

            const time = new Date(notification.createdAt).toLocaleString('ko-KR');
            
            notificationDiv.innerHTML = `
                <div class="notification-type">${notification.type}</div>
                <div class="notification-content">${notification.content}</div>
                <div class="notification-time">${time}</div>
                <div class="notification-actions">
                    ${!notification.read ? `<button onclick="markAsRead(${notification.id})" class="btn-small btn-success">ì½ìŒ ì²˜ë¦¬</button>` : ''}
                    <button onclick="deleteNotification(${notification.id})" class="btn-small btn-danger">ì‚­ì œ</button>
                </div>
            `;

            const existing = container.querySelector(`#notification-${notification.id}`);
            if (existing) {
                existing.replaceWith(notificationDiv);
            } else {
                container.insertBefore(notificationDiv, container.firstChild);
            }
        }

        // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
        async function markAsRead(notificationId) {
            if (!authToken) return;

            try {
                const response = await fetch(`http://localhost:8080/api/notifications/${notificationId}/read`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    log(`ì•Œë¦¼ ${notificationId} ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ`, 'success');
                    const notificationDiv = document.getElementById(`notification-${notificationId}`);
                    if (notificationDiv) {
                        notificationDiv.classList.add('read');
                        notificationDiv.querySelector('.notification-actions').innerHTML = `
                            <button onclick="deleteNotification(${notificationId})" class="btn-small btn-danger">ì‚­ì œ</button>
                        `;
                    }
                    loadNotifications();
                }
            } catch (error) {
                log(`ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
        async function markAllAsRead() {
            if (!authToken) return;

            try {
                const response = await fetch('http://localhost:8080/api/notifications/read-all', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    log('ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ', 'success');
                    loadNotifications();
                }
            } catch (error) {
                log(`ì „ì²´ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì•Œë¦¼ ì‚­ì œ
        async function deleteNotification(notificationId) {
            if (!authToken) return;

            if (!confirm('ì •ë§ë¡œ ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`http://localhost:8080/api/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    log(`ì•Œë¦¼ ${notificationId} ì‚­ì œ ì™„ë£Œ`, 'success');
                    const notificationDiv = document.getElementById(`notification-${notificationId}`);
                    if (notificationDiv) {
                        notificationDiv.remove();
                    }
                    updateStats();
                }
            } catch (error) {
                log(`ì•Œë¦¼ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œë¡œ í†µê³„ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜
            const totalElement = document.getElementById('totalNotifications');
            const unreadElement = document.getElementById('unreadNotifications');
            const sentElement = document.getElementById('sentNotifications');

            if (totalElement && unreadElement && sentElement) {
                // ì‹¤ì œ ì•Œë¦¼ ê°œìˆ˜ëŠ” loadNotificationsì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨
                // ì—¬ê¸°ì„œëŠ” ë³´ë‚¸ ì•Œë¦¼ë§Œ ì—…ë°ì´íŠ¸
                sentElement.textContent = sentCount;
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showNotificationToast(notification) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ìƒˆë¡œìš´ ì•Œë¦¼', {
                    body: notification.content,
                    icon: '/favicon.ico'
                });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            log('NotiFyah ê³ ê¸‰ ì•Œë¦¼ í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ WebSocket ì—°ê²° í•´ì œ
        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html> 